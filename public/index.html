<!DOCTYPE html>
<html lang="en" class="bg-gray-100 text-gray-800">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Generator & Scanner</title>
    <link rel="icon" href="/images/favicon.ico" />
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="p-6">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-md">
        <h1 class="text-2xl font-bold mb-4 text-center">üì∑ QR Code Scanner</h1>

        <div class="flex flex-wrap justify-center gap-4 my-4">
            <button id="ask-permission" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                ‚úÖ ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á
            </button>
            <button id="scan-toggle" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                ‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô
            </button>
            <button id="upload-file" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">
                üìÅ ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
            </button>
            <button id="reset-permission" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
            </button>
            <label for="file-input" class="sr-only">Upload QR Code Image</label>
            <input id="file-input" type="file" accept="image/*" class="hidden" title="Upload QR Code Image" />
        </div>

        <div id="reader" class="mb-4 w-full max-w-md mx-auto"></div>
        <div id="scan-result" class="text-center text-sm text-gray-600 mt-2"></div>

        <hr class="my-6" />

        <h2 class="text-xl font-semibold mb-2 text-center">üéØ Generate QR Code</h2>
        <form id="generate-form" class="flex flex-col gap-4 items-center">
            <input id="qr-text" type="text" placeholder="Enter text to generate QR Code"
                class="w-full max-w-md px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring focus:border-blue-300" />
            <button type="submit"
                class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">Generate</button>
        </form>

        <div id="qr-result" class="mt-4 text-center hidden">
            <h3 class="text-lg font-medium mb-2">Generated QR Code:</h3>
            <img id="qr-image" class="mx-auto border p-2" alt="Generated QR Code" />
        </div>
    </div>

    <script>
        const sendScannedTextToServer = async (text) => {
            try {
                const res = await fetch('/api/scan-result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text })
                });

                const data = await res.json();
                console.log("üì° Server response:", data);
            } catch (err) {
                console.error("‚ùå Failed to send scanned text:", err);
            }
        };
    </script>

    <script>
        let html5QrCode = null;
        let isScanning = false;
        let selectedCameraId = null;

        const scanBtn = document.getElementById("scan-toggle");
        const permissionBtn = document.getElementById("ask-permission");
        const resetBtn = document.getElementById("reset-permission");
        const uploadBtn = document.getElementById("upload-file");
        const fileInput = document.getElementById("file-input");
        const resultElem = document.getElementById("scan-result");

        // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏π‡πâ‡∏ú‡∏•‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
        const controlButtons = [scanBtn, resetBtn];
        controlButtons.forEach(btn => btn.style.display = "none");

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
        const checkCameraPermissionOnLoad = async () => {
            if (!navigator.permissions) return;

            try {
                const status = await navigator.permissions.query({ name: 'camera' });
                handlePermissionState(status.state);

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
                status.onchange = () => handlePermissionState(status.state);
            } catch (err) {
                console.warn("Permission API not supported or blocked", err);
            }
        };

        const handlePermissionState = (state) => {
            if (state === "granted") {
                permissionBtn.style.display = "none";
                controlButtons.forEach(btn => btn.style.display = "inline-block");
            } else if (state === "prompt") {
                permissionBtn.style.display = "inline-block";
                controlButtons.forEach(btn => btn.style.display = "none");
            } else if (state === "denied") {
                permissionBtn.style.display = "inline-block";
                resetBtn.style.display = "inline-block";
                scanBtn.style.display = "none";
            }
        };

        // ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á
        const requestCameraPermission = async () => {
            try {
                await navigator.mediaDevices.getUserMedia({ video: true });
                alert("‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß");
                checkCameraPermissionOnLoad(); // ‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
            } catch (err) {
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ");
                console.error(err);
            }
        };

        const resetCameraPermission = () => {
            alert(`1. ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô üîí ‡∏ö‡∏ô URL\n2. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Site Settings\n3. ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Camera\n4. Refresh ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö`);
            const url = `chrome://settings/content/siteDetails?site=${window.location.origin}`;
            if (navigator.userAgent.includes("Chrome")) window.open(url, "_blank");
        };

        const selectCamera = async () => {
            const devices = await Html5Qrcode.getCameras();
            if (!devices.length) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á");
            const backCam = devices.find(d => d.label.toLowerCase().includes("back"));
            selectedCameraId = (backCam || devices[0]).id;
        };

        const updateScanButton = (active) => {
            isScanning = active;
            scanBtn.innerText = active ? "‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô" : "‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô";
            scanBtn.classList.toggle("bg-blue-600", !active);
            scanBtn.classList.toggle("hover:bg-blue-700", !active);
            scanBtn.classList.toggle("bg-gray-600", active);
            scanBtn.classList.toggle("hover:bg-gray-700", active);
        };

        const toggleScanCamera = async () => {
            if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
            if (!selectedCameraId) {
                try {
                    await selectCamera();
                } catch (err) {
                    alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ");
                    return;
                }
            }

            if (!isScanning) {
                try {
                    await html5QrCode.start(
                        selectedCameraId,
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        text => {
                            resultElem.innerText = `Scanned Text: ${text}`
                            sendScannedTextToServer(text);
                        },
                        err => console.warn("Scan error:", err)
                    );
                    updateScanButton(true);
                } catch (err) {
                    console.error("Start scan failed:", err);
                }
            } else {
                try {
                    await html5QrCode.stop();
                    updateScanButton(false);
                } catch (err) {
                    console.error("Stop scan failed:", err);
                }
            }
        };

        const scanFromImageFile = async (file) => {
            const qrScanner = new Html5Qrcode("reader");
            try {
                const result = await qrScanner.scanFile(file, true);
                await sendScannedTextToServer(result);
                resultElem.innerText = `Scanned from file: ${result}`;
            } catch (err) {
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô QR ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ");
                console.error("File scan error:", err);
            }
        };

        const handleUploadClick = () => fileInput.click();
        const handleFileChange = (e) => {
            const file = e.target.files[0];
            if (file) scanFromImageFile(file);
        };

        const generateQrCode = async (e) => {
            e.preventDefault();
            const text = document.getElementById("qr-text").value;
            if (!text) return;

            try {
                const res = await fetch(`/api/gen-qrcode?text=${encodeURIComponent(text)}`);
                const data = await res.json();
                if (data.qr) {
                    document.getElementById("qr-image").src = data.qr;
                    document.getElementById("qr-result").classList.remove("hidden");
                }
            } catch (err) {
                console.error("Error generating QR:", err);
            }
        };

        // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° event ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ
        document.getElementById("ask-permission").addEventListener("click", requestCameraPermission);
        document.getElementById("reset-permission").addEventListener("click", resetCameraPermission);
        document.getElementById("scan-toggle").addEventListener("click", toggleScanCamera);
        document.getElementById("upload-file").addEventListener("click", handleUploadClick);
        document.getElementById("file-input").addEventListener("change", handleFileChange);
        document.getElementById("generate-form").addEventListener("submit", generateQrCode);

        // üöÄ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        window.addEventListener("DOMContentLoaded", checkCameraPermissionOnLoad);
    </script>
</body>

</html>